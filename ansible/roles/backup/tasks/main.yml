---
- name: Install restic
  ansible.builtin.apt:
    name: restic
    state: present
  when: not use_prebaked_image
  tags: [install]

- name: Generate restic password
  ansible.builtin.command:
    cmd: openssl rand -hex 32
  register: restic_password_result
  changed_when: false
  when: restic_password == ""
  no_log: true
  tags: [config]

- name: Set restic password fact
  ansible.builtin.set_fact:
    _restic_password: "{{ restic_password if restic_password != '' else restic_password_result.stdout }}"
  no_log: true
  tags: [config]

- name: Set spaces region fact
  ansible.builtin.set_fact:
    _spaces_region: "{{ spaces_region if spaces_region != '' else region | default('nyc3') }}"
  tags: [config]

- name: Template restic environment file
  ansible.builtin.template:
    src: restic-env.j2
    dest: /home/openclaw/.restic-env
    owner: openclaw
    group: openclaw
    mode: "0600"
  no_log: true
  tags: [config]

- name: Initialize restic repository
  ansible.builtin.shell:
    cmd: set -a && source /home/openclaw/.restic-env && set +a && restic init
  args:
    executable: /bin/bash
  become: true
  become_user: openclaw
  register: restic_init
  changed_when: "'created restic repository' in restic_init.stdout"
  failed_when: "restic_init.rc != 0 and 'already initialized' not in restic_init.stderr"
  no_log: true
  tags: [config]

- name: Template backup systemd service
  ansible.builtin.template:
    src: openclaw-backup.service.j2
    dest: /etc/systemd/system/openclaw-backup.service
    mode: "0644"
  notify: Reload systemd for backup
  tags: [service]

- name: Template backup systemd timer
  ansible.builtin.template:
    src: openclaw-backup.timer.j2
    dest: /etc/systemd/system/openclaw-backup.timer
    mode: "0644"
  notify:
    - Reload systemd for backup
    - Enable backup timer
  tags: [service]

- name: Enable and start backup timer
  ansible.builtin.service:
    name: openclaw-backup.timer
    state: started
    enabled: true
  tags: [service]

- name: Template backup check systemd service
  ansible.builtin.template:
    src: openclaw-backup-check.service.j2
    dest: /etc/systemd/system/openclaw-backup-check.service
    mode: "0644"
  notify: Reload systemd for backup
  tags: [service]

- name: Template backup check systemd timer
  ansible.builtin.template:
    src: openclaw-backup-check.timer.j2
    dest: /etc/systemd/system/openclaw-backup-check.timer
    mode: "0644"
  notify:
    - Reload systemd for backup
  tags: [service]

- name: Enable and start backup check timer
  ansible.builtin.service:
    name: openclaw-backup-check.timer
    state: started
    enabled: true
  tags: [service]

- name: Save restic password to local file
  ansible.builtin.copy:
    content: "{{ _restic_password }}"
    dest: "{{ playbook_dir }}/.restic-password"
    mode: "0600"
  delegate_to: localhost
  become: false
  no_log: true
  tags: [config]

- name: Notify about restic password
  ansible.builtin.debug:
    msg: "Restic backup password saved to {{ playbook_dir }}/.restic-password -- back this up securely!"
  tags: [config]
