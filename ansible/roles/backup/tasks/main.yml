---
- name: Generate restic password
  ansible.builtin.command:
    cmd: openssl rand -hex 32
  register: restic_password_result
  changed_when: false
  when: restic_password == ""
  no_log: true

- name: Set restic password fact
  ansible.builtin.set_fact:
    _restic_password: "{{ restic_password if restic_password != '' else restic_password_result.stdout }}"
  no_log: true

- name: Set spaces region fact
  ansible.builtin.set_fact:
    _spaces_region: "{{ spaces_region if spaces_region != '' else region | default('nyc3') }}"

- name: Template restic environment file
  ansible.builtin.template:
    src: restic-env.j2
    dest: /home/openclaw/.restic-env
    owner: openclaw
    group: openclaw
    mode: "0600"
  no_log: true

- name: Initialize restic repository
  ansible.builtin.command:
    cmd: docker compose -f /opt/openclaw/docker-compose.yml run --rm restic restic init
  register: restic_init
  changed_when: "'created restic repository' in restic_init.stdout"
  failed_when: "restic_init.rc != 0 and 'already initialized' not in restic_init.stderr"
  no_log: true

- name: Template backup systemd service
  ansible.builtin.template:
    src: openclaw-backup.service.j2
    dest: /etc/systemd/system/openclaw-backup.service
    mode: "0644"
  notify: Reload systemd for backup

- name: Template backup systemd timer
  ansible.builtin.template:
    src: openclaw-backup.timer.j2
    dest: /etc/systemd/system/openclaw-backup.timer
    mode: "0644"
  notify:
    - Reload systemd for backup
    - Enable backup timer

- name: Enable and start backup timer
  ansible.builtin.service:
    name: openclaw-backup.timer
    state: started
    enabled: true

- name: Save restic password to local file
  ansible.builtin.copy:
    content: "{{ _restic_password }}"
    dest: "{{ playbook_dir }}/.restic-password"
    mode: "0600"
  delegate_to: localhost
  become: false
  no_log: true

- name: Notify about restic password
  ansible.builtin.debug:
    msg: "Restic backup password saved to {{ playbook_dir }}/.restic-password -- back this up securely!"
