---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install base packages
  ansible.builtin.apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
    state: present

- name: Create openclaw user
  ansible.builtin.user:
    name: openclaw
    shell: /bin/bash
    groups: sudo
    append: true
    create_home: true

- name: Allow openclaw user passwordless sudo
  ansible.builtin.copy:
    content: "openclaw ALL=(ALL) NOPASSWD:ALL\n"
    dest: /etc/sudoers.d/openclaw
    mode: "0440"
    validate: "visudo -cf %s"

- name: Copy SSH authorized keys to openclaw user
  ansible.posix.authorized_key:
    user: openclaw
    key: "{{ lookup('file', ssh_public_key_path) }}"
    state: present

- name: Disable root SSH login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin no"
  notify: Restart sshd

- name: Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication no"
  notify: Restart sshd

- name: Configure UFW defaults
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: incoming, policy: deny }
    - { direction: outgoing, policy: allow }

- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Enable UFW
  community.general.ufw:
    state: enabled

- name: Configure fail2ban for SSH
  ansible.builtin.copy:
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      maxretry = 5
      bantime = 3600
    dest: /etc/fail2ban/jail.local
    mode: "0644"
  notify: Restart fail2ban

- name: Enable unattended-upgrades
  ansible.builtin.dpkg_selections:
    name: unattended-upgrades
    selection: install
