---
- name: Deploy OpenClaw to DigitalOcean Droplet
  hosts: openclaw
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check for Terraform vars file
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/terraform_vars.yml"
      register: _terraform_vars
      delegate_to: localhost
      become: false
      tags: [always]

    - name: Load Terraform-generated variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/terraform_vars.yml"
      when: _terraform_vars.stat.exists
      tags: [always]

  roles:
    - role: common
      tags: [common]

    - role: docker
      tags: [docker]

    - role: openclaw
      tags: [openclaw]

    - role: traefik
      tags: [traefik]
      when: access_method == "https"

    - role: tailscale
      tags: [tailscale]
      when: enable_tailscale | bool

    - role: backup
      tags: [backup]
      when: enable_backup | bool

    - role: monitoring
      tags: [monitoring]
      when: enable_monitoring | bool

  post_tasks:
    - name: Run OpenClaw doctor check
      ansible.builtin.command:
        cmd: /home/openclaw/.local/bin/openclaw doctor --fix
      become: true
      become_user: openclaw
      environment:
        PATH: "/home/openclaw/.local/bin:/home/openclaw/.local/share/pnpm:{{ ansible_env.PATH }}"
        HOME: "/home/openclaw"
      register: doctor_result
      changed_when: "'fixed' in doctor_result.stdout"
      failed_when: false
      tags: [deploy]

    - name: Display doctor output
      ansible.builtin.debug:
        msg: "{{ doctor_result.stdout_lines | default([]) }}"
      when: doctor_result.stdout_lines | default([]) | length > 0
      tags: [deploy]

    - name: Post-deploy connection info
      ansible.builtin.debug:
        msg: |
          ============================================
          OpenClaw deployed successfully!

          Access method: {{ access_method }}
          {% if access_method == 'ssh_tunnel' %}
          Connect via SSH tunnel:
            ssh -L 18789:localhost:18789 openclaw@{{ ansible_host }}
          Then open: http://localhost:18789
          {% elif access_method == 'https' %}
          Open: https://{{ domain_name }}
          {% endif %}
          {% if enable_tailscale | bool %}
          Tailscale: Enabled -- also available on your Tailscale network.
          {% endif %}

          {% if claude_setup_token != "" %}
          Claude auth: Configured via setup-token
          {% else %}
          To configure Claude subscription auth:
            ssh openclaw@{{ ansible_host }}
            ./setup-claude-token.sh
          {% endif %}

          {% if enable_control_ui | default(true) | bool %}
          Control UI: {{ 'https://' ~ domain_name ~ '/openclaw' if access_method == 'https' else 'http://localhost:18789/openclaw (via SSH tunnel)' }}
          {% endif %}

          {% if telegram_bot_token != "" %}
          Telegram bot: Enabled (DM policy: {{ telegram_dm_policy }})
          {% endif %}
          {% if openclaw_channels | default([]) | length > 0 %}
          Channels enabled: {{ openclaw_channels | join(', ') }}
          Configure channel credentials via Control UI or SSH.
          {% endif %}
          {% if telegram_bot_token == "" and openclaw_channels | default([]) | length == 0 %}
          To add channels:
            ssh openclaw@{{ ansible_host }}
            openclaw channels add
          {% endif %}

          Management commands (on server):
            sudo systemctl status openclaw-gateway
            sudo journalctl -u openclaw-gateway -f
            sudo systemctl restart openclaw-gateway
          ============================================
      tags: [always]
