# Example workflow for automated Packer image builds.
# Disabled by default â€” to enable, uncomment the triggers below and add
# a DO_API_TOKEN secret to your GitHub repository settings.
#
# Usage:
#   1. Go to Settings > Secrets > Actions in your GitHub repo
#   2. Add DO_API_TOKEN with your DigitalOcean API token
#   3. Uncomment the 'on:' block below
#   4. The workflow will build on packer/ changes, weekly, or manual dispatch

name: Build Image

on:
  workflow_dispatch:  # keep manual trigger for on-demand builds
  # Uncomment below to enable automatic builds:
  # push:
  #   branches: [main]
  #   paths:
  #     - "packer/**"
  # schedule:
  #   # Weekly on Sunday at 04:00 UTC
  #   - cron: "0 4 * * 0"

jobs:
  validate:
    name: Validate Packer
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packer
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-packer@main

      - name: Packer Init
        run: packer init .

      - name: Packer Format Check
        run: packer fmt -check .

      - name: Packer Validate
        run: packer validate .
        env:
          PKR_VAR_do_token: "validation-only"

  build:
    name: Build Snapshot
    needs: validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packer
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-packer@main

      - name: Packer Init
        run: packer init .

      - name: Build Image
        run: packer build .
        env:
          PKR_VAR_do_token: ${{ secrets.DO_API_TOKEN }}

      - name: Summary
        run: echo "Snapshot built successfully. Check DigitalOcean console for the new image." >> "$GITHUB_STEP_SUMMARY"
